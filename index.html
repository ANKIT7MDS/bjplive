<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>рдЖрдЧрдВрддреБрдХ рдлреЙрд░реНрдо</title>
  <style>/* ... рдЖрдкрдХрд╛ рдкрд╣рд▓реЗ рд╡рд╛рд▓рд╛ рд╕реНрдЯрд╛рдЗрд▓ ... */</style>
</head>
<body>
  <form id="visitorForm">
    <!-- рд╕рднреА рдлрд╝реАрд▓реНрдб рд╡реИрд╕реЗ рд╣реА рдЬреИрд╕реЗ рдкрд╣рд▓реЗ -->
    <input type="tel" name="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░" required>
    <input type="text" name="рдирд╛рдо" required>
    <input type="text" name="рдкрдж">
    <select name="рдордВрдбрд▓" required>...mandal options...</select>
    <input type="text" name="рдмреВрде / рд╡рд╛рд░реНрдб / рдкрддрд╛">
    <select name="purpose" required>...purpose options...</select>

    <!-- Hidden for selfie -->
    <input type="hidden" name="Selfie" id="selfieInput">

    <!-- Camera and preview UI -->
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photoPreview" style="display:none; width:100px;">
    <button type="button" id="capture">ЁЯУ╕ рдлреЛрдЯреЛ рдХреИрдкреНрдЪрд░ рдХрд░реЗрдВ</button>
    <div id="photoStatus" class="message"></div>

    <button type="submit">ЁЯУи рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ</button>
    <div id="submitStatus" class="message"></div>
  </form>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const selfieInput = document.getElementById('selfieInput');
    const preview = document.getElementById('photoPreview');
    const photoStatus = document.getElementById('photoStatus');
    const submitStatus = document.getElementById('submitStatus');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(e => alert("рдХреИрдорд░рд╛ рдЪрд╛рд▓реВ рдирд╣реАрдВ рд╣реБрдЖ"));

    document.getElementById('capture').addEventListener('click', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const dataURL = canvas.toDataURL('image/png');
      selfieInput.value = dataURL;
      preview.src = dataURL;
      preview.style.display = 'block';
      photoStatus.innerText = 'тЬЕ рдлреЛрдЯреЛ рдХреИрдкреНрдЪрд░ рд╣реЛ рдЧрдИ рд╣реИ';
    });

    document.getElementById('visitorForm').addEventListener('submit', e => {
      e.preventDefault();
      submitStatus.innerText = 'ЁЯФД рд╕рдмрдорд┐рдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ...';

      // тЬЕ рд╕рднреА рдлреЙрд░реНрдо рдлреАрд▓реНрдбреНрд╕ + Selfie hidden input рдПрдХ рд╕рд╛рде рднреЗрдЬрдирд╛
      const form = e.target;
      const params = new URLSearchParams();
      Array.from(form.elements).forEach(el => {
        if (el.name)
          params.append(el.name, el.value);
      });

      fetch("https://script.google.com/macros/s/AKfycbтАж/exec", {
        method: "POST",
        body: params
      })
      .then(res => res.json())
      .then(data => {
        if (data.result === "success") {
          submitStatus.innerHTML = 'ЁЯОЙ рдЖрдкрдХрд╛ рдлреЙрд░реНрдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдмрдорд┐рдЯ рд╣реБрдЖ';
          form.reset();
          preview.style.display = 'none';
          photoStatus.innerText = '';
        } else {
          submitStatus.innerText = 'тЭМ рддреНрд░реБрдЯрд┐: ' + data.error;
        }
      })
      .catch(err => {
        submitStatus.innerText = 'тЭМ рдиреЗрдЯрд╡рд░реНрдХ рддреНрд░реБрдЯрд┐: ' + err.message;
      });
    });
  </script>
</body>
</html>
